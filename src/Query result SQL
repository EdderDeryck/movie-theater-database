-- Consulta 1: Mostrar filmes com distribuidora e classificação indicativa
SELECT 
    m.title AS filme,
    d.name AS distribuidora,
    mr.age_limit AS classificacao,
    mr.explanation AS descricao
FROM movies m
JOIN distributors d ON m.distributor_id = d.distributor_id
LEFT JOIN movie_restrictions mr ON m.movie_id = mr.movie_id
ORDER BY m.title;

-- Consulta 2: Listar sessões com data, horário, filme, sala e cinema
SELECT 
    s.show_date,
    s.show_time,
    m.title AS filme,
    h.hall_number AS sala,
    c.name AS cinema
FROM showings s
JOIN movies m ON s.movie_id = m.movie_id
JOIN halls h ON s.hall_id = h.hall_id
JOIN cinema c ON h.cinema_id = c.cinema_id
ORDER BY s.show_date, s.show_time;

-- Consulta 3: Mostrar ingressos completos: usuário, filme, sessão, sala e cinema
SELECT 
    u.name AS usuario,
    m.title AS filme,
    s.show_date,
    s.show_time,
    h.hall_number AS sala,
    c.name AS cinema,
    t.seat_number
FROM tickets t
JOIN users u ON t.user_id = u.users_id
JOIN showings s ON t.showing_id = s.showing_id
JOIN movies m ON s.movie_id = m.movie_id
JOIN halls h ON s.hall_id = h.hall_id
JOIN cinema c ON h.cinema_id = c.cinema_id
ORDER BY u.name, s.show_date;

-- Consulta 4: Listar funcionários, cargos, cinema e tempo de contratação
SELECT 
    e.name AS funcionario,
    e.role AS cargo,
    c.name AS cinema,
    TIMESTAMPDIFF(YEAR, e.hire_date, CURDATE()) AS anos_contratado
FROM employees e
JOIN cinema c ON e.cinema_id = c.cinema_id
ORDER BY anos_contratado DESC;

-- Consulta 5: Mostrar filmes com seus gêneros e quantidade total de gêneros
SELECT 
    m.title AS filme,
    GROUP_CONCAT(g.name SEPARATOR ', ') AS generos,
    COUNT(mg.genre_id) AS total_generos
FROM movies m
JOIN movie_genres mg ON m.movie_id = mg.movie_id
JOIN genres g ON mg.genre_id = g.genre_id
GROUP BY m.movie_id
ORDER BY m.title;

-- Consulta 6: Exibir sessões com promoções ativas e seus descontos
SELECT 
    s.show_date,
    s.show_time,
    m.title AS filme,
    p.name AS promocao,
    p.discount_percent
FROM showings s
JOIN movies m ON s.movie_id = m.movie_id
JOIN showing_promotions sp ON s.showing_id = sp.showing_id
JOIN promotions p ON sp.promotion_id = p.promotion_id
WHERE s.show_date BETWEEN p.start_date AND p.end_date
ORDER BY s.show_date, s.show_time;

-- Consulta 7: Mostrar pagamentos por usuário, métodos usados e total gasto
SELECT 
    u.name AS usuario,
    p.payment_method,
    SUM(p.paid_value) AS total_gasto
FROM payments p
JOIN tickets t ON p.ticket_id = t.ticket_id
JOIN users u ON t.user_id = u.users_id
GROUP BY u.users_id, p.payment_method
ORDER BY total_gasto DESC;

-- Consulta 8: Calcular média das avaliações dos filmes por gênero
SELECT 
    g.name AS genero,
    AVG(r.rating) AS media_avaliacao
FROM reviews r
JOIN movies m ON r.movie_id = m.movie_id
JOIN movie_genres mg ON m.movie_id = mg.movie_id
JOIN genres g ON mg.genre_id = g.genre_id
GROUP BY g.genre_id
ORDER BY media_avaliacao DESC;

-- Consulta 9: Mostrar receita total das sessões, ingressos vendidos e promoções aplicadas
SELECT 
    s.showing_id,
    m.title AS filme,
    COUNT(t.ticket_id) AS ingressos_vendidos,
    SUM(paid_value) AS receita_total,
    GROUP_CONCAT(DISTINCT pr.name SEPARATOR ', ') AS promocoes
FROM showings s
JOIN movies m ON s.movie_id = m.movie_id
LEFT JOIN tickets t ON t.showing_id = s.showing_id
LEFT JOIN payments pay ON t.ticket_id = pay.ticket_id
LEFT JOIN showing_promotions sp ON s.showing_id = sp.showing_id
LEFT JOIN promotions pr ON sp.promotion_id = pr.promotion_id 
GROUP BY s.showing_id
ORDER BY receita_total DESC;

-- Consulta 10: Listar filmes com mais de 120 minutos, sessões de 2025 e média de avaliações
SELECT 
    m.title AS filme,
    m.duration_minutes,
    AVG(r.rating) AS media_avaliacao,
    COUNT(DISTINCT s.showing_id) AS total_sessoes
FROM movies m
JOIN showings s ON m.movie_id = s.movie_id
LEFT JOIN reviews r ON m.movie_id = r.movie_id
WHERE m.duration_minutes > 120
  AND YEAR(s.show_date) = 2025
GROUP BY m.movie_id
ORDER BY media_avaliacao DESC;

-- Consulta 11: Listar usuários sem compras registradas
SELECT 
    u.name AS usuario,
    u.email
FROM users u
LEFT JOIN tickets t ON u.users_id = t.user_id
WHERE t.ticket_id IS NULL
ORDER BY u.name;

-- Consulta 12: Top 3 promoções com maior impacto financeiro
SELECT 
    pr.name AS promocao,
    SUM(p.paid_value) AS impacto_financeiro
FROM promotions pr
JOIN showing_promotions sp ON pr.promotion_id = sp.promotion_id
JOIN showings s ON sp.showing_id = s.showing_id
JOIN tickets t ON t.showing_id = s.showing_id
JOIN payments p ON t.ticket_id = p.ticket_id
WHERE s.show_date BETWEEN pr.start_date AND pr.end_date
GROUP BY pr.promotion_id
ORDER BY impacto_financeiro DESC
LIMIT 3;

-- Consulta 13: Listar salas com capacidade >100 e estatísticas de 2025
SELECT 
    h.hall_number AS sala,
    c.name AS cinema,
    h.capacity,
    COUNT(DISTINCT s.showing_id) AS sessoes_2025,
    COUNT(DISTINCT t.ticket_id) AS ingressos_vendidos
FROM halls h
JOIN cinema c ON h.cinema_id = c.cinema_id
LEFT JOIN showings s ON h.hall_id = s.hall_id AND YEAR(s.show_date) = 2025
LEFT JOIN tickets t ON t.showing_id = s.showing_id
WHERE h.capacity > 100
GROUP BY h.hall_id
ORDER BY ingressos_vendidos DESC;

-- Consulta 14: Ranking dos filmes mais vendidos com receita média por ingresso
SELECT 
    m.title AS filme,
    COUNT(t.ticket_id) AS ingressos_vendidos,
    SUM(pay.paid_value) AS receita_total,
    AVG(pay.paid_value) AS receita_media_por_ingresso
FROM movies m
JOIN showings s ON m.movie_id = s.movie_id
LEFT JOIN tickets t ON t.showing_id = s.showing_id
LEFT JOIN payments pay ON t.ticket_id = pay.ticket_id
GROUP BY m.movie_id
ORDER BY ingressos_vendidos DESC, receita_total DESC;