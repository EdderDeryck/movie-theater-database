-- Consulta 1 -> Filmes com distribuidor e classificação indicativa
SELECT m.title AS filme, d.name AS distribuidora, mr.age_limit AS classificacao, mr.explanation AS motivo
FROM movies m
JOIN distributors d ON m.distributor_id = d.distributor_id
JOIN movie_restrictions mr ON m.movie_id = mr.movie_id
ORDER BY m.title;

-- Consulta 2 -> Sessões com filme, sala e cinema
SELECT s.show_date AS data, s.show_time AS horario, m.title AS filme, h.hall_number AS sala, c.name AS cinema
FROM showings s
JOIN movies m ON s.movie_id = m.movie_id
JOIN halls h ON s.hall_id = h.hall_id
JOIN cinema c ON h.cinema_id = c.cinema_id
ORDER BY s.show_date, s.show_time;

-- Consulta 3 -> Ticket completo: usuário, filme, sessão, sala e cinema (5 JOINs)
SELECT t.ticket_id AS ingresso, u.name AS usuario, m.title AS filme, s.show_date AS data, s.show_time AS horario,
       h.hall_number AS sala, c.name AS cinema, t.seat_number AS assento
FROM tickets t
JOIN users u ON t.user_id = u.users_id
JOIN showings s ON t.showing_id = s.showing_id
JOIN movies m ON s.movie_id = m.movie_id
JOIN halls h ON s.hall_id = h.hall_id
JOIN cinema c ON h.cinema_id = c.cinema_id
ORDER BY t.ticket_id;

-- Consulta 4 -> Funcionários e seus respectivos cinemas
SELECT e.name AS funcionario, e.role AS cargo, e.hire_date AS data_admissao, c.name AS cinema,
       TIMESTAMPDIFF(YEAR, e.hire_date, '2025-11-26') AS anos_de_casa
FROM employees e
JOIN cinema c ON e.cinema_id = c.cinema_id
ORDER BY e.hire_date;

-- Consulta 5 -> Filmes e gêneros relacionados
SELECT m.title AS filme, g.name AS genero,
       (SELECT COUNT(*) FROM movie_genres mg2 WHERE mg2.movie_id = m.movie_id) AS total_generos
FROM movies m
JOIN movie_genres mg ON m.movie_id = mg.movie_id
JOIN genres g ON mg.genre_id = g.genre_id
ORDER BY m.title, g.name;

-- Consulta 6 -> Sessões com promoção e desconto
SELECT s.show_date AS data, s.show_time AS horario, m.title AS filme, p.name AS promocao, p.discount_percent AS desconto
FROM showings s
JOIN movies m ON s.movie_id = m.movie_id
JOIN showing_promotions sp ON s.showing_id = sp.showing_id
JOIN promotions p ON sp.promotion_id = p.promotion_id
WHERE '2025-11-26' BETWEEN p.start_date AND p.end_date
ORDER BY s.show_date, s.show_time;

-- Consulta 7 -> Pagamentos por usuário com métodos utilizados
SELECT u.name AS usuario,
       COUNT(p.payment_id) AS total_pagamentos,
       GROUP_CONCAT(DISTINCT p.payment_method ORDER BY p.payment_method) AS metodos,
       SUM(p.paid_value) AS total_gasto
FROM users u
JOIN tickets t ON u.users_id = t.user_id
JOIN payments p ON t.ticket_id = p.ticket_id
GROUP BY u.users_id
ORDER BY total_gasto DESC;

-- Consulta 8 -> Média de avaliações dos filmes por gênero
SELECT m.title AS filme, g.name AS genero,
       AVG(r.rating) AS media_avaliacao,
       COUNT(r.review_id) AS total_avaliacoes
FROM movies m
JOIN movie_genres mg ON m.movie_id = mg.movie_id
JOIN genres g ON mg.genre_id = g.genre_id
LEFT JOIN reviews r ON m.movie_id = r.movie_id
GROUP BY m.movie_id, g.genre_id
HAVING total_avaliacoes > 0
ORDER BY media_avaliacao DESC;

-- Consulta 9 -> Receita total por sessão com promoções e ingressos vendidos (7 JOINs)
SELECT s.showing_id AS sessao, m.title AS filme, c.name AS cinema, h.hall_number AS sala,
       COUNT(t.ticket_id) AS ingressos_vendidos,
       COALESCE(SUM(paid.paid_value),0) AS receita_total,
       GROUP_CONCAT(DISTINCT pr.name) AS promocoes
FROM showings s
JOIN movies m ON s.movie_id = m.movie_id
JOIN halls h ON s.hall_id = h.hall_id
JOIN cinema c ON h.cinema_id = c.cinema_id
LEFT JOIN showing_promotions sp ON s.showing_id = sp.showing_id
LEFT JOIN promotions pr ON sp.promotion_id = pr.promotion_id
LEFT JOIN tickets t ON s.showing_id = t.showing_id
LEFT JOIN payments paid ON t.ticket_id = paid.ticket_id
GROUP BY s.showing_id;

-- Consulta 10 -> Filmes com duração superior a 120 minutos
SELECT m.movie_id AS id, m.title AS filme, m.duration_minutes AS duracao, d.name AS distribuidora,
       COUNT(s.showing_id) AS total_sessoes_2025,
       ROUND(AVG(r.rating),2) AS media_avaliacoes
FROM movies m
LEFT JOIN distributors d ON m.distributor_id = d.distributor_id
LEFT JOIN showings s ON m.movie_id = s.movie_id AND YEAR(s.show_date)=2025
LEFT JOIN reviews r ON m.movie_id = r.movie_id AND YEAR(r.review_date)=2025
WHERE m.duration_minutes > 120
GROUP BY m.movie_id;

-- Consulta 11 -> Usuários sem compras registradas
SELECT u.users_id AS id, u.name AS usuario, u.email AS email, u.created_at AS data_criacao,
       COUNT(t.ticket_id) AS compras,
       GROUP_CONCAT(DISTINCT p.name) AS promocoes_ativas
FROM users u
LEFT JOIN tickets t ON u.users_id = t.user_id
LEFT JOIN showing_promotions sp ON sp.showing_id = t.showing_id
LEFT JOIN promotions p ON sp.promotion_id = p.promotion_id
WHERE t.ticket_id IS NULL
GROUP BY u.users_id;

-- Consulta 12 -> Top 3 promoções com maior impacto financeiro
SELECT p.promotion_id AS id, p.name AS promocao, p.discount_percent AS desconto,
       COUNT(DISTINCT sp.showing_id) AS total_sessoes,
       COALESCE(SUM(pay.paid_value),0) AS receita
FROM promotions p
LEFT JOIN showing_promotions sp ON p.promotion_id = sp.promotion_id
LEFT JOIN showings s ON sp.showing_id = s.showing_id
LEFT JOIN tickets t ON s.showing_id = t.showing_id
LEFT JOIN payments pay ON t.ticket_id = pay.ticket_id
GROUP BY p.promotion_id
ORDER BY receita DESC, total_sessoes DESC
LIMIT 3;

-- Consulta 13 -> Salas com capacidade superior a 100 lugares
SELECT h.hall_id AS id, c.name AS cinema, h.hall_number AS sala, h.capacity AS capacidade,
       COUNT(DISTINCT s.showing_id) AS total_sessoes_2025,
       COUNT(t.ticket_id) AS ingressos_vendidos
FROM halls h
JOIN cinema c ON h.cinema_id = c.cinema_id
LEFT JOIN showings s ON h.hall_id = s.hall_id AND YEAR(s.show_date)=2025
LEFT JOIN tickets t ON s.showing_id = t.showing_id
WHERE h.capacity > 100
GROUP BY h.hall_id;

-- Consulta 14 -> Ranking dos filmes mais vendidos com receita média por ingresso
SELECT m.movie_id AS id, m.title AS filme,
       COUNT(t.ticket_id) AS total_ingressos,
       COALESCE(SUM(p.paid_value),0) AS receita_total,
       CASE WHEN COUNT(t.ticket_id) > 0
            THEN ROUND(SUM(p.paid_value)/COUNT(t.ticket_id),2)
            ELSE 0 END AS receita_media
FROM movies m
LEFT JOIN showings s ON m.movie_id = s.movie_id
LEFT JOIN tickets t ON s.showing_id = t.showing_id
LEFT JOIN payments p ON t.ticket_id = p.ticket_id
GROUP BY m.movie_id
ORDER BY total_ingressos DESC, receita_total DESC;

-- Tabelas conectadas:
-- showings → movies, halls, cinema, showing_promotions, promotions, tickets, payments
SELECT s.showing_id, m.title, c.name, h.hall_number,
       COUNT(t.ticket_id) AS ingressos_vendidos,
       COALESCE(SUM(paid.paid_value),0) AS receita_total,
       GROUP_CONCAT(DISTINCT pr.name) AS promocoes
FROM showings s
JOIN movies m ON s.movie_id = m.movie_id
JOIN halls h ON s.hall_id = h.hall_id
JOIN cinema c ON h.cinema_id = c.cinema_id
LEFT JOIN showing_promotions sp ON s.showing_id = sp.showing_id
LEFT JOIN promotions pr ON sp.promotion_id = pr.promotion_id
LEFT JOIN tickets t ON s.showing_id = t.showing_id
LEFT JOIN payments paid ON t.ticket_id = paid.ticket_id
GROUP BY s.showing_id;